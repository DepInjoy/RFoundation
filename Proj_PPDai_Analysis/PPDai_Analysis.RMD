---
拍拍贷用户数据探索
========================================================
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)
```
本文针对拍拍贷业务数据进行分析，该数据包包含了成交时间从2015年1月1日到2017年1月30日的328553支信用标，主要有三个csv数据集文件构成：

- LC(Loan Characteristics)表，标的特征表，每支标一条记录。共有21个字段，包括一个主键（listingid）、7个标的特征和13个成交当时的借款人信息，全部为成交当时可以获得的信息。
  - ListingId
  - 借款金额
  - 借款期限
  - 借款利率
  - 借款成功日期
  - 初始评级
  - 借款类型
  - 是否首标
  - 年龄
  - 性别
  - 手机认证
  - 户口认证
  - 视频认证
  - 学历认证
  - 征信认证
  - 淘宝认证
  - 历史成功借款次数
  - 历史成功借款金额
  - 总待还本金
  - 历史正常还款期数
  - 历史逾期还款期数

- LP(Loan Periodic) 表，标的还款计划和还款记录，每支标每期还款为一条记录。还款记录和状态更新至2017年2月22日。共有10个字段，包括两个主键（listingid和期数），3个还款计划字段和4个还款状态字段。
- LCIS(Loan Characteristics Investment Status)表：

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
library(ggplot2)
library(gridExtra)
library(dplyr)
# 设置数据显示非科学计数法
options(scipen=3)
```

```{r echo=FALSE, Load_the_Data}
# 加载数据
lc <- read.csv("ppdai/LC.csv", fileEncoding = "utf-8")
lp <- read.csv("ppdai/LP.csv", fileEncoding = "utf-8")
lcis <- read.csv("ppdai/LCIS.csv", fileEncoding = "utf-8")
```
```{r}
names(lc)
```

```{r}
str(lc)
```
```{r warning=FALSE message = FALSE}
str(lp)
```
```{r warning=FALSE, message=FALSE}
str(lcis)
```
## 数据评估和清洗
```{r}
# 观察是否有重复的数据，无重复数据，无须处理
sum(duplicated(lc$ListingId))
```

```{r warning=FALSE, message=FALSE, change_Data_Format}
# 将借款成功日期的类型由Factor更改为Date
lc$'借款成功日期' <- as.Date(lc$'借款成功日期')
str(lc)
```


## 用户画像分析

### 不同性别的用户年龄分布关系
```{r echo=FALSE, Univariate_Plots}
ggplot(aes(x = lc$'性别'), data = lc) +
    geom_histogram(stat = "count", width=0.2) +
    labs(x = "性别", y = "用户数", title = "不同性别用户数分布") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16))
```
拍拍贷的客户中男性客户多于女性。
### 不同年龄的用户数分布关系
```{r}
summary(lc$'年龄')
```

```{r echo=FALSE}
lc$age.group = cut(lc$'年龄', 
    breaks = c(16, 18, 22, 25, 28, 35, 40, 60), right = F,
    labels = c('小于18岁', '18到22岁', '22到25岁', '25到28岁', 
               '28到35岁', '35到40岁', '40岁以上'))

p1 <- ggplot(aes(x = age.group), data = lc) +
    geom_histogram(stat = "count") +
    labs(x = "用户年龄分组", y = "用户数",title = "不同年龄组用户数分布") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
          axis.text.x = element_text(angle = 30, hjust = 1))

p2 <- ggplot(aes(x = age.group, fill =lc$'性别'), data = lc) +
    geom_histogram(stat = "count") +
    labs(x = "用户年龄分组", y = "用户数",title = "不同年龄组用户数分布") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
          axis.text.x = element_text(angle = 30, hjust = 1))

grid.arrange(p1, p2, ncol=2)
```
拍拍贷用户的年龄位于17到56岁之间，将用户的年龄划分为小于18岁，18到22岁'，22到25岁，25到28岁，28到35，35到40岁以及40岁以上几个区间段对用户数分析，其中28到35岁的用户数量时最多的，其次是25岁到28岁，再其次是22到25岁，而且小于18岁的用户数很少，在整个客户群体中几乎可以忽略。

### 认证用户分布
将用户进行的手机认证、户口认证等，每进行一项认证加一分，形成一个认证得分auth指标之后。
```{r}
lc$auth <- 0
lc$auth <- apply(lc, 1, function(x){
  y = 0
  if(x['手机认证'] == '成功认证') y = y + 1
  if(x['户口认证'] == '成功认证') y = y + 1
  if(x['视频认证'] == '成功认证') y = y + 1
  if(x['学历认证'] == '成功认证') y = y + 1
  if(x['征信认证'] == '成功认证') y = y + 1
  if(x['淘宝认证'] == '成功认证') y = y + 1
  x["auth"] = y
})
```

```{r}
p1 <- ggplot(aes(x=lc$'手机认证'), data=lc)+
    geom_histogram(stat = "count") +
    labs(x="手机认证", y="用户数", title="手机认证的用户数分布")

p2 <- ggplot(aes(x=lc$'户口认证'), data=lc)+
    geom_histogram(stat = "count")+
    labs(x="户口认证", y="用户数", title="户口认证的用户数分布")

p3 <- ggplot(aes(x=lc$'视频认证'), data=lc)+
    geom_histogram(stat = "count")+
    labs(x="视频认证", y="用户数", title="视频认证的用户数分布")

p4 <- ggplot(aes(x=lc$'学历认证'), data=lc)+
    geom_histogram(stat = "count")+
    labs(x="学历认证", y="用户数", title="学历认证的用户数分布")

p5 <- ggplot(aes(x=lc$'征信认证'), data=lc)+
    geom_histogram(stat = "count")+
    labs(x="征信认证", y="用户数", title="征信认证的用户数分布")

p6 <- ggplot(aes(x=lc$'淘宝认证'), data=lc)+
    geom_histogram(stat = "count")+
    labs(x="淘宝认证", y="用户数", title="淘宝认证的用户数分布")

grid.arrange(p1, p2, p3, p4, p5, p6, ncol=3)
```
经过对用户群体中的手机认证、户口认证、视频认证、学历认证、征信认证、淘宝认证的各项认证的整体情况来看，未完成认证的用户均高于成功进行认证的用户数，特别，完成户口认证、视频认证、征信认证、淘宝认证的用户微乎其微，相对来说有比较高的客户进行了手机认证和学历认证，接下来对用户的计算出的认证得分的用户分布进行观察。

```{r}
ggplot(aes(x=factor(auth)), data=lc)+
    geom_histogram(stat = "count") +
    scale_y_log10(breaks=c(10, 100, 1000, 5000, 10000, 100000)) +
    labs(x="认证得分", y="log(用户数)", title="手机认证的用户数分布") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16))
```
从认证得分可以看出在统计的手机认证、户口认证、视频认证、学历认证、征信认证、淘宝认证刘翔认证中，绝大数无认证或者只完成了其中的一到两项认证，只有极少数的人完成了6项认证。


## 用户基础数据分析
### 用户借款分布
```{r}
p1 <- ggplot(aes(x = lc$'借款类型'),data = lc) +
    geom_histogram(stat = "count") +
    labs(x = "用户借款类型", y = "人数", title = "用户借款类型分布关系图")

p2 <- ggplot(aes(x = lc$'借款类型', fill = lc$'性别'),data = lc) +
    geom_histogram(stat = "count") +
    labs(x = "用户借款类型", y = "人数", 
         title = "不同性别和用户借款类型分布关系图")

grid.arrange(p1, p2, ncol=2)
```
通过观察借款类型，普通性用户最多，其次是APP闪电，再其次是其他，电商用户很少，微乎其微，各不同借款类型中，都是男性占比较大。

### 借款金额分布
```{r}
# 查看借款金额的统计指标
summary(lc$'借款金额')
```
```{r}
lc$amount.group <- cut(lc$'借款金额',
          c(0, 1000, 2000, 3000, 4000, 5000, 6000, 8000, 10000, 50000, 500001),
          labels = c('1千以下', '1千到2千', '2千到3千', '3千到4千', '4千到5千', 
                     '5千到6千', '6千到8千', '8千到1万', '1万到5万', '5万以上'),
          right = F)
p1 <- ggplot(aes(x = lc$'借款金额'), data = lc) +
    geom_freqpoly() +
    scale_x_log10(breaks = c(1000, 2000, 3000, 4000, 5000, 6000, 10000, 50000),
                  limits = c(500, 50000)) +
    labs(x = "借款金额", y = "用户数", title="不同借款金额用户数量分布") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
  
p2 <- ggplot(aes(x = amount.group), data = lc) +
    geom_histogram(stat = 'count') +
    labs(x = "借款金额区间", y = "用户数", title="不同借款金额区间的用户数量分布") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
  
grid.arrange(p1, p2, ncol = 2)
```
### 借款利率的用户数量分布
```{r}
table(lc$'借款利率')
```

```{r}
ggplot(aes(x = lc$'借款利率'), data = lc) +
    geom_histogram(binwidth = 0.5) +
    scale_y_log10(breaks = c(1, 10, 100, 1000, 10000, 100000)) +
    scale_x_continuous(breaks=seq(6, 24, 1), limits = c(6, 24)) +
    labs(x="借款利率", y="用户数", title="不同借款利率的用户数分布") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16))
```
用户的借款利率从6.5%到24%，各个利率阶段用户的数据较为分散，其中再20%和22%用户数量均超过100000，分别126330和137899这样的，这两者已经占到总用户的50%以上。

### 信用评级的用户数量分布
```{r}
p1 <- ggplot(aes(x = lc$'初始评级'), data = lc)+
    geom_histogram(stat = "count")+
    labs(x = "信用评级", y = "用户数", title="信用评级在用户数上分布") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16))

p2 <- ggplot(aes(x = lc$'初始评级', fill=age.group), data = lc)+
    geom_histogram(stat = "count")+
    labs(x = "信用评级", y = "用户数", title="信用评级和用户年龄分组在用户数上分布情况") +
    theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16))
grid.arrange(p1, p2, ncol=2)
```
用户的信用等级为D的用户最多，其次是C，这两者占用户信用等级的绝大多数，在不同的信用等级下，相对28到35岁的用户偏多，其次是25到28岁的。

### 历史正常还款次数的用户数分布
```{r}
table(lc$'历史成功借款次数')
```

```{r fig.width=35}
p1 <- ggplot(aes(x = lc$'历史成功借款次数'), data = lc) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(limits = c(-1,20)) +
    labs(x="历史成功借款次数", y="用户数", title="历史正常还款次数的用户数分布")

p2 <- ggplot(aes(x = lc$'历史成功借款次数', fill=lc$'初始评级'), data = lc) +
    geom_histogram(binwidth = 1) +
    scale_x_continuous(limits = c(-1,20)) +
    labs(x="历史成功借款次数", y="用户数", title="历史正常还款次数的用户数分布")

grid.arrange(p1, p2, ncol=2)
```

用户的成功借款次数分布较为离散，取值范围从0到649，绝大数分布于0到20次，其中有87463用户历史成功借款次数为0，是用户数最多的，之后随着历史成功借款次数的增加用户数量随之减少。

## 风险要素分析

### 违约概率PD
```{r warning=FALSE, message=FALSE, echo=FALSE}
lc$default_rate <- lc$'历史逾期还款期数'/ lc$'历史成功借款次数'
# 将由于历史成功借款次数为0导致上述计算的违约概率为na的值更改为0
lc$default_rate[is.na(lc$default_rate)] <- 0
sum(lc$default_rate == 0)
```

```{r}
ggplot(aes(x = default_rate), data = lc) +
    geom_histogram(binwidth = 0.1) +
    scale_x_continuous(limits = c(1, 12))
```
用户违约概率分布再0到12，其中违约概率为0的用户数高达278185，占总用户数的84.7%，其他的用户数较少。

### 违约损失率LGD
```{r echo=FALSE}
lc$LGD <- lc$'总待还本金'/lc$'借款金额'
# 将借款金额为0，经过上述运算得到的违约损失率设置为0
lc$LGD[is.na(lc$LGD)] <- 0
p1 <- ggplot(aes(y =LGD), data = lc) +
    geom_boxplot() +
    scale_y_continuous(limits = c(0,4),breaks = seq(0, 4, 0.5)) +
    labs(y = "违约损失率LGD", title = "违约损失率箱线图")

p2 <- ggplot(aes(x = lc$'初始评级', y =LGD), data = lc) +
    geom_boxplot() +
    coord_cartesian(ylim = c(0,4.0)) +
    labs(x= "初始评级", y = "违约损失率LGD", title = "违约损失率箱线图")
grid.arrange(p1, p2, ncol=2)
```
```{r}
summary(lc$LGD)
```


### 到期日(Maturity)

### 违约时暴露(Exposure at Default, EAD)


## 获客指标分析
### 日新增用户数
```{r}
sub_lc = subset(lc, lc$'是否首标' == '是')
ggplot(aes(x = sub_lc$"借款成功日期"), data = sub_lc) +
    geom_freqpoly() +
    labs(x="借款成功日期", y = "客户数", title="日新增用户变化曲线")
```

## 变现指标分析
### 贷款利率和违约率之间的关系
```{r}
ggplot(aes(x=lc$'借款利率', y=default_rate, color=lc$"初始评级"), data=lc) +
    geom_jitter(alpha=1/10) +
    labs(x="借款利率", y="违约率", title="贷款利率和借款利率之间的关系")
```

# 单变量分析

### 你的数据集结构是什么？

### 你的数据集内感兴趣的主要特性有哪些？

### 你认为数据集内哪些其他特征可以帮助你探索兴趣特点？

### 根据数据集内已有变量，你是否创建了任何新变量？

### 在已经探究的特性中，是否存在任何异常分布？你是否对数据进行一些操作，如清洁、调整或改变数据的形式？如果是，你为什么会这样做？



# 双变量绘图选择
```{r echo=FALSE, Bivariate_Plots}

```

# 双变量分析

### 探讨你在这部分探究中观察到的一些关系。这些感兴趣的特性与数据集内其他特性有什么区别？

### 你是否观察到主要特性与其他特性之间的有趣关系？

### 你发现最强的关系是什么？




# 多变量绘图选择

```{r echo=FALSE, Multivariate_Plots}

```

# 多变量分析

###  探讨你在这部分探究中观察到的一些关系。通过观察感兴趣的特性，是否存在相互促进的特性？

### 这些特性之间是否存在有趣或惊人的联系呢？

### 选项：你是否创建过数据集的任何模型？讨论你模型的优缺点。

------

# 定稿图与总结

### 绘图一
```{r echo=FALSE, Plot_One}

```

### 描述一


### 绘图二
```{r echo=FALSE, Plot_Two}

```

### 描述二


### 绘图三
```{r echo=FALSE, Plot_Three}

```

### 描述三

------

# 反思